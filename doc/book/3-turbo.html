<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>v1.1.{0-1}: Preprocessing - Lattice Land Book</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
                <link rel="stylesheet" href="custom.css">
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Lattice Land</a></li><li class="chapter-item expanded affix "><li class="part-title">CUDA Battery Library</li><li class="chapter-item expanded "><a href="1-cuda-battery.html"><strong aria-hidden="true">2.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="2-cuda-battery.html"><strong aria-hidden="true">3.</strong> Data from CPU to GPU</a></li><li class="chapter-item expanded "><a href="3-cuda-battery.html"><strong aria-hidden="true">4.</strong> CMake Project</a></li><li class="chapter-item expanded "><a href="4-cuda-battery.html"><strong aria-hidden="true">5.</strong> In-Kernel Allocation</a></li><li class="chapter-item expanded "><a href="5-cuda-battery.html"><strong aria-hidden="true">6.</strong> Shared Memory Allocator</a></li><li class="chapter-item expanded "><a href="6-cuda-battery.html"><strong aria-hidden="true">7.</strong> Caution</a></li><li class="chapter-item expanded affix "><li class="part-title">Seminars</li><li class="chapter-item expanded "><a href="abstract-week.html"><strong aria-hidden="true">8.</strong> Abstract Interpretation Workshop (2024)</a></li><li class="chapter-item expanded affix "><li class="part-title">Turbo Technical Journal</li><li class="chapter-item expanded "><a href="1-turbo.html"><strong aria-hidden="true">9.</strong> Introducing Turbo</a></li><li class="chapter-item expanded "><a href="2-turbo.html"><strong aria-hidden="true">10.</strong> v1.0.1: Unoptimized Turbo</a></li><li class="chapter-item expanded "><a href="3-turbo.html" class="active"><strong aria-hidden="true">11.</strong> v1.1.{0-1}: Preprocessing</a></li><li class="chapter-item expanded "><a href="4-turbo.html"><strong aria-hidden="true">12.</strong> v1.1.2: (Dis)equality Propagator</a></li><li class="chapter-item expanded "><a href="5-turbo.html"><strong aria-hidden="true">13.</strong> v1.1.3: Warp Synchronization</a></li><li class="chapter-item expanded "><a href="6-turbo.html"><strong aria-hidden="true">14.</strong> v1.1.{4-5}: Sorting Propagators</a></li><li class="chapter-item expanded "><a href="7-turbo.html"><strong aria-hidden="true">15.</strong> v1.1.{6-7}: Sharing Propagators</a></li><li class="chapter-item expanded "><a href="8-turbo.html"><strong aria-hidden="true">16.</strong> v1.2.0: Refactoring</a></li><li class="chapter-item expanded "><a href="9-turbo.html"><strong aria-hidden="true">17.</strong> v1.2.{1-3}: Open Hackathon</a></li><li class="chapter-item expanded "><a href="10-turbo.html"><strong aria-hidden="true">18.</strong> v1.2.4: Ternary Normal Form</a></li><li class="chapter-item expanded "><a href="11-turbo.html"><strong aria-hidden="true">19.</strong> v1.2.5: Trivially Copyable</a></li><li class="chapter-item expanded affix "><li class="part-title">About</li><li class="chapter-item expanded "><a href="about.html"><strong aria-hidden="true">20.</strong> About</a></li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Lattice Land Book</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="v110-1-preprocessing"><a class="header" href="#v110-1-preprocessing">v1.1.{0-1}: Preprocessing</a></h1>
<p><em>27 December 2023.</em> A simple definition of <em>preprocessing</em> is to prepare the constraint problem hence it can be solved more efficiently by the underlying solver.
The goal of preprocessing is usually to eliminate fixed variables, eliminate satisfied constraints and simplify constraints, for instance by propagating the constants.
In the context of GPU, there is an additional incentive to preprocessing: reducing the memory footprint in order to store the problem in the shared memory (L2 cache).
For now, most of the problems are too large to be entirely stored in shared memory (store of variables and propagators), but the variables can be entirely stored in the shared memory for around 30% of the problems considered.
We have implemented a simple preprocessing class called <code>Simplifier</code> (in lala-core).
After propagating the root node, the preprocessor performs the following simplifications:</p>
<ol>
<li>Replace all assigned variables by the constant they are assigned to.</li>
<li>Create equivalence classes among variables (by detecting <code>x = y</code> constraints), select a representative variable in each class, and replace all occurrences of the variables in the equivalence classes by their representative variables.</li>
<li>Remove entailed constraints.</li>
</ol>
<p>The preprocessing algorithm is in theory suitable for parallel execution on GPU, but it is currently executed on the CPU.
The reason is that we want to reduce the problem size to store the variables in the shared memory.
But we must decide in which memory to put the variables before we start the GPU kernel; hence we would need to launch the preprocessing in a kernel, to return the data to the CPU and relaunch another kernel with the right shared memory size.
There is a solution using CUDA dynamic parallelism, but I did not take the time to explore it yet!</p>
<p>This simple preprocessing step doubles the raw efficiency of the solver as measured by the number of nodes explored per second.
Indeed, reducing the problem leads to fewer propagators that need to be executed, which is observed by a reduction of the number of iterations to reach a fixpoint (-14% on average).
But the additional speed is also explained by the variables store that has been cut by half on average and the propagators' memory decreased by 22%.
It reduces the pressure on the L1 and L2 caches and more problems can be stored in the shared memory; in our case, one more problem can be stored in shared memory when simplifying.</p>
<table><thead><tr><th>Metrics</th><th>Average</th><th>Δ v1.0.1</th><th>Median</th><th>Δ v1.0.1</th></tr></thead><tbody>
<tr><td>Nodes per seconds</td><td>2379.95</td><td>+91%</td><td>611.27</td><td>+1742%</td></tr>
<tr><td>Fixpoint iterations per second</td><td>12303.02</td><td>+23%</td><td>2273.83</td><td>+882%</td></tr>
<tr><td>Fixpoint iterations per node</td><td>7.31</td><td>-14%</td><td>5.9</td><td>-17%</td></tr>
<tr><td>#Problems with IDLE SMs at timeout</td><td>9</td><td>13</td><td></td><td></td></tr>
<tr><td>Propagators memory</td><td>12.65MB</td><td>-22%</td><td>7.79MB</td><td>-40%</td></tr>
<tr><td>Variables store memory</td><td>72.29KB</td><td>-57%</td><td>84.1KB</td><td>-52%</td></tr>
<tr><td>#Problems at optimality</td><td>10</td><td>5</td><td></td><td></td></tr>
<tr><td>#Problems satisfiable</td><td>22</td><td>27</td><td></td><td></td></tr>
<tr><td>#Problems unknown</td><td>3</td><td>3</td><td></td><td></td></tr>
</tbody></table>
<p><img src="turbo-v1.1/turbogpu-v1.0.1-vs-turbogpu-v1.1.0.png" alt="TurboGPU-v1.0.1 vs TurboGPU-v1.1.0" /></p>
<h2 id="v110b-increasing-the-number-of-subproblems"><a class="header" href="#v110b-increasing-the-number-of-subproblems">v1.1.0b Increasing the number of subproblems</a></h2>
<p>By default, the number of subproblems created is 1024 (2^10) (option <code>-sub 10</code>).
This choice is rather arbitrary, so I ran additional experiments to see if increasing that number could lead to better results.
The answer is that it is quite hard to choose a good generic number, but overall 4096 (2^12) subproblems gave better results and is the new default for the future versions.</p>
<table><thead><tr><th>Metrics</th><th>Average</th><th>Δ v1.1.0</th><th>Median</th><th>Δ v1.1.0</th></tr></thead><tbody>
<tr><td>Nodes per seconds</td><td>2529.68</td><td>+6%</td><td>809.31</td><td>+32%</td></tr>
<tr><td>Fixpoint iterations per second</td><td>12449.48</td><td>+1%</td><td>3306.37</td><td>+45%</td></tr>
<tr><td>Fixpoint iterations per node</td><td>6.77</td><td>-7%</td><td>5.19</td><td>-12%</td></tr>
<tr><td>#Problems with IDLE SMs at timeout</td><td>7</td><td>9</td><td></td><td></td></tr>
<tr><td>Propagators memory</td><td>12.65MB</td><td>0%</td><td>7.79MB</td><td>0%</td></tr>
<tr><td>Variables store memory</td><td>72.29KB</td><td>0%</td><td>84.1KB</td><td>0%</td></tr>
<tr><td>#Problems at optimality</td><td>11</td><td>10</td><td></td><td></td></tr>
<tr><td>#Problems satisfiable</td><td>21</td><td>22</td><td></td><td></td></tr>
<tr><td>#Problems unknown</td><td>3</td><td>3</td><td></td><td></td></tr>
</tbody></table>
<p>In particular, we see that increasing the number of subproblems to 4096 contributes to a better average of nodes per second and to solving one more problem to optimality.
With more subproblems, the advantage is not as clear, but it is definitely an experiment to try again on future versions of Turbo.</p>
<p><img src="turbo-v1.1/turbogpu-v1.1.0-1024-vs-turbogpu-v1.1.0-4096.png" alt="TurboGPU-v1.1.0 vs TurboGPU-v1.1.0b" /></p>
<h2 id="v111-partial-evaluation"><a class="header" href="#v111-partial-evaluation">v1.1.1 Partial evaluation</a></h2>
<p>The version 1.1.1 brings partial evaluation of the logical formulas, essentially by aggregating constants and rewriting constraints with fewer operators.
We fully evaluate the expressions without variables, using commutativity laws for addition and multiplication (e.g. in <code>4 + x + 1</code> we evaluate <code>4 + 1</code>).
We apply some standard simplification laws:</p>
<ul>
<li>Propagating neutral and absorber elements (using identity and annihilator laws) of conjunction, disjunction, implication, equivalence, addition, subtraction, multiplication and division.</li>
<li>Eliminating double arithmetic and logical negations.</li>
</ul>
<p>We also have a bunch of rules to simplify constraints that are generated by the MiniZinc to FlatZinc conversion (let <code>eval</code> be a function evaluating the constant expressions):</p>
<ul>
<li>Detecting equalities: <code>x + (-y) == 0</code> is rewritten to <code>x == y</code>.</li>
<li>Detecting inequalities: <code>x + (-y) != 0</code> is rewritten to <code>x != y</code>.</li>
<li>Aggregating constants: <code>x + i != j</code> is rewritten to <code>x != eval(j - i)</code>.</li>
<li>Eliminating variable negation: <code>-x != j</code> is rewritten to <code>x != eval(-j)</code> (and similarly for <code>j != -x</code>).</li>
</ul>
<p>These rules could be generalized in the future.</p>
<p>This simple optimization leads to another big leap in the number of nodes per second and reduces significantly the memory footprint of propagators.
For the first time, there is a problem (nfc_24_4_2) that can be entirely stored in the shared memory (store of variables and propagators).
However, the impact of being entirely in the shared memory is not very impressive, with &quot;only&quot; 42% more nodes per second in comparison to v1.1.0b, knowing the average is at 62%.
We should validate experimentally if manually managing the shared memory is really worth it, or if the default caching policy of CUDA does a good enough job.</p>
<table><thead><tr><th>Metrics</th><th>Average</th><th>Δ v1.1.0b</th><th>Median</th><th>Δ v1.1.0b</th></tr></thead><tbody>
<tr><td>Nodes per second</td><td>4087.42</td><td>+62%</td><td>976.72</td><td>+21%</td></tr>
<tr><td>Fixpoint iterations per second</td><td>17837.83</td><td>+43%</td><td>3878.13</td><td>+17%</td></tr>
<tr><td>Fixpoint iterations per node</td><td>6.79</td><td>+0.3%</td><td>5.17</td><td>-0.4%</td></tr>
<tr><td>#Problems with IDLE SMs at timeout</td><td>8</td><td>7</td><td></td><td></td></tr>
<tr><td>Propagators memory</td><td>10.34MB</td><td>-18%</td><td>7.39MB</td><td>-5%</td></tr>
<tr><td>Variables store memory</td><td>72.29KB</td><td>0%</td><td>84.1KB</td><td>0%</td></tr>
<tr><td>#Problems at optimality</td><td>11</td><td>10</td><td></td><td></td></tr>
<tr><td>#Problems satisfiable</td><td>22</td><td>22</td><td></td><td></td></tr>
<tr><td>#Problems unknown</td><td>2</td><td>3</td><td></td><td></td></tr>
</tbody></table>
<h2 id="overall-standing"><a class="header" href="#overall-standing">Overall standing</a></h2>
<p><img src="turbo-v1.1/overall-standing-v1.1.0.png" alt="Overall standing" /></p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="2-turbo.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="4-turbo.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="2-turbo.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="4-turbo.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
