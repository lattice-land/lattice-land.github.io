<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>v1.2.4: Ternary Normal Form - Lattice Land Book</title>


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon.svg">
        <link rel="shortcut icon" href="favicon.png">
        <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
        <link rel="stylesheet" href="css/print.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
        <link rel="stylesheet" href="fonts/fonts.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="highlight-css" href="highlight.css">
        <link rel="stylesheet" id="tomorrow-night-css" href="tomorrow-night.css">
        <link rel="stylesheet" id="ayu-highlight-css" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        <link rel="stylesheet" href="custom.css">


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc.js"></script>
    </head>
    <body>
    <div id="body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
            }
            sidebar_toggle.checked = sidebar === 'visible';
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="sidebar-toggle" class="icon-button" for="sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </label>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                        <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                    </div>

                    <h1 class="menu-title">Lattice Land Book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>

                    </div>
                </div>

                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="v124-ternary-normal-form"><a class="header" href="#v124-ternary-normal-form">v1.2.4: Ternary Normal Form</a></h1>
<p><em>27 December 2024.</em> During the hackathon with Nvidia, we profiled the code and discovered that the representation of propagators was problematic.
Let's take an example with the constraint <code>x * x + y &lt; 5</code> which is internally represented by the following AST:</p>
<img src="turbo-v1.2/propagator_tree.png" alt="isolated" width="250"/>
<p>Because the constraints can have any arity and be arbitrarily deep, we have no choice but to represent this tree with pointers and dynamic memory allocation.
In Turbo, we used <a href="https://en.cppreference.com/w/cpp/utility/variant">variant</a> and <a href="https://en.cppreference.com/w/cpp/memory/shared_ptr">shared_ptr</a> to represent propagators.
The propagators are executed using a switch statement of the following form:</p>
<pre><code class="language-cpp">switch(term.index()) {
  case IVar:
  case IConstant:
  case INeg:
  case IAdd:
  case ISub:
  case IMul:
  // ...
</code></pre>
<p>In the profiling report, it is shown that <code>switch(term.index())</code> generates a lot of uncoalesced accesses.
Previously, we have reduced divergent branches by sorting propagators with the same shape (see <a href="https://lattice-land.github.io/6-turbo.html">sorting propagators</a>).
But the main issue was the uncoalesced accesses to the propagators.</p>
<p>To address this, we propose decomposing the problem into constraints that can be represented without pointers (fixed depth) and that are small (to enable coalesced memory load).
For this purpose, we introduce a new problem decomposition call the <em>ternary normal form</em> (TNF) where all propagators are of the form <code>x = y &lt;op&gt; z</code> with <code>x,y,z</code> variables.
Furthermore, we take a minimal set of operators that includes the arithmetic operators <code>+,-,*,/,min,max</code> and two comparison operators <code>&lt;=, =</code>.
All the other constraints are rewritten into those operators.
The constraint <code>x * x + y &lt; z</code> in TNF is:</p>
<pre><code>t1 = x * x
t2 = t1 * y
ONE = (t2 &lt;= z)
</code></pre>
<p>Where <code>t1,t2,ONE</code> are new variables where <code>ONE</code> is initialized to <code>1</code>.
Note that the symbol <code>=</code> is relational, hence using <code>ONE = (t2 &lt;= z)</code> forces the constraint on the right to be true.
This is called a "reified constraint" in the jargon of constraint programming, but in TNF it has the same representation as any other constraint.
TNF allows us to represent compactly a propagator using:</p>
<pre><code class="language-cpp">struct bytecode_type {
  Sig op;
  AVar x;
  AVar y;
  AVar z;
};
</code></pre>
<p><code>AVar</code> is an integer representing the index of the variable in the store and <code>Sig</code> is also an integer representing the operator.</p>
<h2 id="problems-in-ternary-normal-form"><a class="header" href="#problems-in-ternary-normal-form">Problems in Ternary Normal Form</a></h2>
<p>One obvious drawback of this approach is the increased number of temporary variables and constraints.
While the increase in the number of constraints is relatively low and stable across problems (between 1x and 4x), the increase in the number of variables ranges between 1x and 139x in the case of the Wordpress problem.
This variability warrants further investigation in the future to explore ways of reducing the number of generated variables.</p>
<div class="table-wrapper"><table><thead><tr><th>Problem</th><th>Data</th><th>#Vars</th><th>#Vars (TNF)</th><th>#Constraints</th><th>#Constraints (TNF)</th></tr></thead><tbody>
<tr><td>team-assignment</td><td>data3_5_31</td><td>15932.0</td><td>35445.0 (x2.22)</td><td>25684.0</td><td>45197.0 (x1.76)</td></tr>
<tr><td>generalized-peacable-queens</td><td>n8_q3</td><td>2940.0</td><td>20186.0 (x6.87)</td><td>8273.0</td><td>25519.0 (x3.08)</td></tr>
<tr><td>spot5</td><td>404</td><td>1112.0</td><td>22053.0 (x19.83)</td><td>8124.0</td><td>29065.0 (x3.58)</td></tr>
<tr><td>nfc</td><td>24_4_2</td><td>169.0</td><td>527.0 (x3.12)</td><td>222.0</td><td>580.0 (x2.61)</td></tr>
<tr><td>blocks-world</td><td>16-4-5</td><td>49447.0</td><td>109068.0 (x2.21)</td><td>73421.0</td><td>133042.0 (x1.81)</td></tr>
<tr><td>triangular</td><td>n39</td><td>3863.0</td><td>207966.0 (x53.84)</td><td>105136.0</td><td>309239.0 (x2.94)</td></tr>
<tr><td>accap</td><td>accap_a4_f30_t15</td><td>530.0</td><td>2319.0 (x4.38)</td><td>993.0</td><td>2782.0 (x2.80)</td></tr>
<tr><td>tower</td><td>100_100_20_100-04</td><td>12547.0</td><td>38559.0 (x3.07)</td><td>23257.0</td><td>49269.0 (x2.12)</td></tr>
<tr><td>roster-sickness</td><td>small-4</td><td>4980.0</td><td>7978.0 (x1.60)</td><td>6067.0</td><td>9116.0 (x1.50)</td></tr>
<tr><td>accap</td><td>accap_a40_f800_t180</td><td>28494.0</td><td>147451.0 (x5.17)</td><td>58616.0</td><td>177573.0 (x3.03)</td></tr>
<tr><td>diameterc-mst</td><td>c_v20_a190_d4</td><td>3045.0</td><td>7336.0 (x2.41)</td><td>6962.0</td><td>11253.0 (x1.62)</td></tr>
<tr><td>triangular</td><td>n10</td><td>267.0</td><td>1370.0 (x5.13)</td><td>765.0</td><td>1868.0 (x2.44)</td></tr>
<tr><td>wordpress</td><td>Wordpress7_Offers500</td><td>667.0</td><td>92695.0 (x138.97)</td><td>30893.0</td><td>122921.0 (x3.98)</td></tr>
<tr><td>roster-sickness</td><td>large-2</td><td>22952.0</td><td>29840.0 (x1.30)</td><td>25693.0</td><td>32653.0 (x1.27)</td></tr>
<tr><td>stripboard</td><td>common-emitter-simple</td><td>2123.0</td><td>14581.0 (x6.87)</td><td>4563.0</td><td>17093.0 (x3.75)</td></tr>
<tr><td>gfd-schedule</td><td>n55f2d50m30k3_10124</td><td>32604.0</td><td>67749.0 (x2.08)</td><td>54575.0</td><td>89720.0 (x1.64)</td></tr>
</tbody></table>
</div>
<h2 id="benchmarks"><a class="header" href="#benchmarks">Benchmarks</a></h2>
<p>The following table compares hybrid v1.2.3 and hybrid v1.2.4, both with 128 blocks.</p>
<div class="table-wrapper"><table><thead><tr><th>Metrics</th><th>Normalized average [0,100]</th><th>Δ v1.2.3</th><th>#best (_/16)</th><th>Average</th><th>Δ v1.2.3</th><th>Median</th><th>Δ v1.2.3</th></tr></thead><tbody>
<tr><td>Nodes per second</td><td>83.75</td><td>+29%</td><td>11</td><td>21808.77</td><td>+18%</td><td>6061.18</td><td>+48%</td></tr>
<tr><td>Fixpoint iterations per second</td><td>100.00</td><td>+254%</td><td>16</td><td>845483.88</td><td>+553%</td><td>143327.93</td><td>+193%</td></tr>
<tr><td>Fixpoint iterations per node</td><td>100.00</td><td>+187%</td><td>0</td><td>40.45</td><td>+138%</td><td>22.76</td><td>+148%</td></tr>
<tr><td>Propagators memory</td><td>19.91</td><td>-80%</td><td>15</td><td>0.85MB</td><td>-90%</td><td>0.42MB</td><td>-89%</td></tr>
<tr><td>Variables store memory</td><td>100.00</td><td>+656%</td><td>0</td><td>402.75KB</td><td>+718%</td><td>208.20KB</td><td>+1844%</td></tr>
</tbody></table>
</div>
<p>Let's analyze the speedup of this new version v1.2.4.
The number of fixpoint iterations per second has increased by 254% which is a very large gain.
However, the increase in nodes per second is only 29%, and it increases in only 11 out of 16 problems.
There are two reasons behind this discrepancy:</p>
<ol>
<li>The convergence of the fixpoint loop is two times slower than in v1.2.3, likely due to improper sorting of the TNF propagators.
In all 16 problems, the new version requires more iterations to converge compared to v1.2.3.</li>
<li>The increase in variables results in fewer problem being stored in shared memory: only 3 out of 16 in comparison to 11 out of 16 before.</li>
</ol>
<p>The first point is somewhat mitigated by the number of fixpoint iterations per second which almost double, demonstrating the effectiveness of TNF for GPU architecture.
Perhaps more surprisingly, the memory footprint of the propagators is much lower than in v1.2.3, with an average reduction of 80%.
Although we have more propagators, each one requires only 16 bytes, as opposed to v1.2.3, where propagator representation involved additional overhead from the shared pointer and variant data structures.</p>
<p>As for the full GPU version, we notice a similar behavior (we compare against full GPU v1.2.0 because v1.2.{1-3} were only modifying the hybrid version):</p>
<div class="table-wrapper"><table><thead><tr><th>Metrics</th><th>Normalized average [0,100]</th><th>Δ v1.2.0</th><th>#best (_/16)</th><th>Average</th><th>Δ v1.2.0</th><th>Median</th><th>Δ v1.2.0</th></tr></thead><tbody>
<tr><td>Nodes per second</td><td>89.02</td><td>+28%</td><td>12</td><td>14467.35</td><td>+24%</td><td>5583.57</td><td>+50%</td></tr>
<tr><td>Fixpoint iterations per second</td><td>100.00</td><td>+315%</td><td>16</td><td>510492.99</td><td>+586%</td><td>136773.93</td><td>+238%</td></tr>
<tr><td>Fixpoint iterations per node</td><td>100.00</td><td>+203%</td><td>0</td><td>40.47</td><td>+167%</td><td>24.07</td><td>+162%</td></tr>
<tr><td>Propagators memory</td><td>19.91</td><td>-80%</td><td>15</td><td>1.03MB</td><td>-90%</td><td>0.51MB</td><td>-89%</td></tr>
<tr><td>Variables store memory</td><td>100.00</td><td>+630%</td><td>0</td><td>402.93KB</td><td>+715%</td><td>208.39KB</td><td>+1813%</td></tr>
</tbody></table>
</div>
<h2 id="profiling"><a class="header" href="#profiling">Profiling</a></h2>
<p>The hackathon reminded me that we should always prioritize the next improvement based on what the profiler reveals.
While this is a well-known principle, it's easy to forget.</p>
<p>During the hackathon, we mainly used the tool <code>ncu</code> to profile our kernels.
It creates a report that can be visualized with <code>ncu-ui</code> and provides various metrics, such as the overall utilization of the SMs, the number of uncoalesced accesses and their locations in the code, the L1/L2 cache hit rates, warp state statistics, and more.
It was in this report we identified the issues with the previous AST-based representation of the propagators.
Among the remaining issues, the report tells us that warps are spending most of their time waiting on <code>__syncthreads()</code> barriers or global memory loads.</p>
<p>Beyond those low-level GPU optimizations, we can also examine the overall behavior of the constraint solver to identify which parts of the algorithm need further optimization.
To achieve this, we equipped Turbo with time counters to track where most of the time is spent in the code.
Let's first focus on the full GPU architecture (<code>-arch gpu</code>).</p>
<p><img src="turbo-v1.2/turbogpu-v1.2.4-time-profile.png" alt="Turbo GPU v1.2.4 Time Profile" /></p>
<p>Clearly, the preprocessing time and the time spent eliminating the entailed propagators (from v1.2.3) are negligible.
The orange section represents the propagation time, and the green section represents the search time.
Prior to optimizing the propagation, the search accounted for about 10-20% of the total time.
However, it has now become a clear candidate for further optimization.
In the full GPU architecture, the search is handled by a single GPU thread which is why it is quite slow.</p>
<p>Next, we look at the hybrid architecture (<code>-or 128 -arch hybrid</code>).</p>
<p><img src="turbo-v1.2/turbohybrid128-v1.2.4-time-profile.png" alt="Turbo Hybrid v1.2.4 Time Profile (128 blocks)" /></p>
<p>Firstly, it is clear that searching on the CPU and memory transfers are not (yet) the bottleneck of the hybrid algorithm.
The time spent in the fixpoint loop is somewhat similar to the full-GPU architecture.
The main difference is the significant amount of time spent waiting for the CPU, as represented by the red section.
One possible explanation is that we have too many CPU threads, while the CPU has few cores (only 10).
To confirm this hypothesis, we should test this version on the GH200, which is powered by a 72-cores ARM CPU.</p>
<p>Based on these charts, there are at least two opportunities to improve efficiency:</p>
<ol>
<li>Continue optimizing the fixpoint loop (this would benefit both architectures, and potentially provide even greater improvements for the hybrid architecture on a CPU with many cores).</li>
<li>Parallelize the search (this would benefit only the full-GPU architecture).</li>
</ol>
<p>From a research perspective it is more interesting to focus on the fixpoint loop parallelization.
Furthermore, improving the full-GPU version---which does not compile on modern GPUs---is less exciting.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                            <a rel="prev" href="9-turbo.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>

                            <a rel="next prefetch" href="11-turbo.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                    <a rel="prev" href="9-turbo.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>

                    <a rel="next prefetch" href="11-turbo.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
            </nav>

        </div>




        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr.min.js"></script>
        <script src="mark.min.js"></script>
        <script src="searcher.js"></script>

        <script src="clipboard.min.js"></script>
        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS scripts -->


    </div>
    </body>
</html>
