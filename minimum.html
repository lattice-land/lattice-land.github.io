<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible no-js light">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Minimum Algorithm - Lattice Land Book</title>
                

        <!-- Custom HTML head -->
        

        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

                <link rel="icon" href="favicon.svg">
                        <link rel="shortcut icon" href="favicon.png">
                <link rel="stylesheet" href="css/variables.css">
        <link rel="stylesheet" href="css/general.css">
        <link rel="stylesheet" href="css/chrome.css">
                <link rel="stylesheet" href="css/print.css" media="print">
        
        <!-- Fonts -->
        <link rel="stylesheet" href="FontAwesome/css/font-awesome.css">
                <link rel="stylesheet" href="fonts/fonts.css">
        
        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme stylesheets -->
        
            </head>
    <body>
        <!-- Provide site root to javascript -->
        <script type="text/javascript">
            var path_to_root = "";
            var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
        </script>

        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            var html = document.querySelector('html');
            html.classList.remove('no-js')
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add('js');
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <div class="sidebar-scrollbox">
                <ol class="chapter"><li class="chapter-item expanded "><a href="index.html"><strong aria-hidden="true">1.</strong> Introduction</a></li><li class="chapter-item expanded "><a href="CUDA-Battery.html"><strong aria-hidden="true">2.</strong> CUDA-Battery Library</a></li><li class="chapter-item expanded affix "><li class="part-title">Parallel Lattice Programming</li><li class="chapter-item expanded "><a href="minimum.html" class="active"><strong aria-hidden="true">3.</strong> Minimum Algorithm</a></li><li class="chapter-item expanded "><a href="floyd-warshall.html"><strong aria-hidden="true">4.</strong> Floyd-Warshall Algorithm</a></li><li class="chapter-item expanded affix "><li class="part-title">Abstract Constraint Reasoning</li><li class="chapter-item expanded affix "><li class="part-title">Parallel Abstract Constraint Reasoning</li></ol>            </div>
            <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar-hover-placeholder"></div>
                <div id="menu-bar" class="menu-bar sticky bordered">
                    <div class="left-buttons">
                        <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                            <i class="fa fa-bars"></i>
                        </button>
                        <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                            <i class="fa fa-paint-brush"></i>
                        </button>
                        <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                        </ul>
                                                <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                            <i class="fa fa-search"></i>
                        </button>
                                            </div>

                    <h1 class="menu-title">Lattice Land Book</h1>

                    <div class="right-buttons">
                                                <a href="print.html" title="Print this book" aria-label="Print this book">
                            <i id="print-button" class="fa fa-print"></i>
                        </a>
                                                                        
                    </div>
                </div>

                                <div id="search-wrapper" class="hidden">
                    <form id="searchbar-outer" class="searchbar-outer">
                        <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                    </form>
                    <div id="searchresults-outer" class="searchresults-outer hidden">
                        <div id="searchresults-header" class="searchresults-header"></div>
                        <ul id="searchresults">
                        </ul>
                    </div>
                </div>
                
                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <h1 id="parallel-minimum-algorithm"><a class="header" href="#parallel-minimum-algorithm">Parallel Minimum Algorithm</a></h1>
<p>We present a simple algorithm computing the minimum element of an array in parallel on GPU.
We introduce the main concepts behind this framework, and give a first grasp to use the library.</p>
<h2 id="an-array-of-element-on-gpu"><a class="header" href="#an-array-of-element-on-gpu">An array of element on GPU</a></h2>
<p>The first thing to do is to create an array of numbers to be passed to a GPU kernel.
As easy as it seems, there is already a small pitfall not to fall in.
Thanks to our library <a href="CUDA-Battery.html">cuda-battery</a>, we can use a <code>vector&lt;int&gt;</code> similarly to what we use on CPU.
Surprisingly, such a simple <code>vector</code> class is not yet available on GPU, although they are working on a copy of the STL called <a href="https://nvidia.github.io/libcudacxx/">libcudacxx</a> working on CUDA GPU.
As soon as <code>vector</code> is available there, we will use the standard one, meanwhile, let's use the one from cuda-battery.
One of the main distinction between CPU and GPU programming is the memory.
On the CPU side, we allocate using <code>new</code> or <code>malloc</code>, but on GPU you should allocate using the more specific <code>cudaMalloc</code>.
Although it does not seem like a big deal, it makes developing code working on both CPU and GPU a bit harder.
We rely on the <em>allocators</em> provided by cuda-battery, and basically all the code is templated by a <code>class Allocator</code>.
In the standard library, the class <code>vector</code> is parametrized by an allocator, and so is the <code>battery::vector</code> version.
Although most of us never use it, it is actually not very difficult.
The safest allocator to use is <code>battery::ManagedAllocator</code> which uses the managed memory of CUDA, which is a memory automatically accessible from the CPU and GPU, and the data migrates automatically between the two worlds.</p>
<pre><code class="language-c++">#include &quot;vector.hpp&quot; // From cuda-battery.
#include &quot;allocator.hpp&quot; // From cuda-battery.

int main() {
  battery::vector&lt;int, battery::ManagedAllocator&gt; v{5, 1, 2, 3};
}
</code></pre>
<p>To make the type shorter, let's use the following alias:</p>
<pre><code class="language-c++">using namespace battery; // let's make things shorter for this tutorial.
using ivector = vector&lt;int, ManagedAllocator&gt;;
</code></pre>
<p>A common use-case is to declare and initialize an array on the CPU and then pass it to the GPU.
However, there is a catch...
None of the following kernel declaration will work as we would like to:</p>
<pre><code class="language-c++">__global__ void min_kernel(ivector&amp; v);
__global__ void min_kernel(const ivector&amp; v);
__global__ void min_kernel(ivector v);
</code></pre>
<p>The two first are not working because the address of <code>v</code> in the main is an address on the CPU side, and of course it does not work when we try to access it on the GPU, so it will segfault.
The third version works but it performs an unwanted copy of the array.
After all, we used a managed allocator to avoid copying the array to the GPU once initialized and declared on the CPU.
There is not a hundred ways to achieve what we want: we need to pass the data through a pointer allocated on the GPU.
Since we are coding in &quot;modern C++&quot;, we will avoid manipulating raw pointers, and instead will rely on <code>shared_ptr</code>.
Once again, a CUDA-friendly version of <code>shared_ptr</code> is provided by cuda-battery.</p>
<pre><code class="language-c++">#include &quot;shared_ptr.hpp&quot;
#include &quot;vector.hpp&quot;
#include &quot;allocator.hpp&quot;

using namespace battery;
using ivector = vector&lt;int, ManagedAllocator&gt;;
using svector = shared_ptr&lt;ivector, ManagedAllocator&gt;;

__global__ void min_kernel(svector v);

int main() {
  svector v = make_shared&lt;ivector, ManagedAllocator&gt;(ivector{5, 1, 2, 3});
}
</code></pre>
<p>Now we can pass an array to our GPU kernel, we can start working on the minimum algorithm.
The result of the algorithm is retrieved using an integer pointer, because CUDA kernels cannot return value.
The rule of thumb is to use <code>shared_ptr&lt;T, ManagedMemory&gt;</code> to pass any argument of type <code>T</code> to a kernel, unless it is a primitive constant.
If you do that, we do not even need to worry about deallocation.
But using <code>shared_ptr</code> for parameters passing is just necessary for the kernel, afterwards, you can use reference parameter passing as usual (see <code>minimum</code> below).</p>
<pre><code class="language-c++">CUDA int minimum(const ivector&amp; v) {
  int result = std::numeric_limits&lt;int&gt;::max();
  for (int i = 0; i &lt; v.size(); ++i) {
    result = min(result, v[i]);
  }
  return result;
}

__global__ void min_kernel(svector v, shared_ptr&lt;int, ManagedAllocator&gt; result) {
  *result = minimum(*v);
}

int main() {
  svector v = make_shared&lt;ivector, ManagedAllocator&gt;(ivector{5, 1, 2, 3});
  shared_ptr&lt;int, ManagedAllocator&gt; result =
    make_shared&lt;int, ManagedAllocator&gt;(std::numeric_limits&lt;int&gt;::max());
  min_kernel&lt;&lt;&lt;1, 1&gt;&gt;&gt;(v, result);
  CUDIE(cudaDeviceSynchronize());
  printf(&quot;minimum: %d\n&quot;, *result);
}
</code></pre>
<h2 id="parallelizing-the-minimum-algorithm"><a class="header" href="#parallelizing-the-minimum-algorithm">Parallelizing the minimum algorithm</a></h2>
<p>The code presented above is still single-threaded, although it runs on the GPU.
A common approach to parallelize <code>minimum</code> is to divide the array into <code>N</code> parts, where <code>N</code> is the number of threads available.
Each thread then computes a local minimum, and a single thread eventually aggregates the results.</p>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                                                    <a rel="prev" href="CUDA-Battery.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        
                                                    <a rel="next" href="floyd-warshall.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        
                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                                    <a rel="prev" href="CUDA-Battery.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                
                                    <a rel="next" href="floyd-warshall.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                            </nav>

        </div>

        
        
        
                <script type="text/javascript">
            window.playground_copyable = true;
        </script>
        
        
                <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        
        <script src="clipboard.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="highlight.js" type="text/javascript" charset="utf-8"></script>
        <script src="book.js" type="text/javascript" charset="utf-8"></script>

        <!-- Custom JS scripts -->
        
        
    </body>
</html>
